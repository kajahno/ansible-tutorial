

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta class="swiftype" name="published_at" data-type="date" content="2017-12-13" /> 
  <meta class="swiftype" name="version" data-type="string" content="3.2.2">

  <!-- Google Tag Manager Data Layer -->
  <script>
   dataLayer = [];
  </script>
  <!-- End Google Tag Manager Data Layer -->

  
  <title>Handling the inventory &mdash; Ansible Quickstart Tutorial 0.0.1 documentation</title>
  

  
  
  
  

  
    <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../../',
        VERSION:'0.0.1',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../../static/jquery.js"></script>
      <script type="text/javascript" src="../../static/underscore.js"></script>
      <script type="text/javascript" src="../../static/doctools.js"></script>
      <script type="text/javascript" src="../../static/language_data.js"></script>

    

  

  
    <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Best practices and first playbook" href="1_playbook.html" /> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>


  
  <script src="../../static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav"> 

  <!-- Google Tag Manager -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PSB293" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-PSB293');</script>
  <!-- End Google Tag Manager -->

    <div class="DocSite-globalNav ansibleNav">
        <ul>
            <li><a href="https://docs.ansible.com/ansible/latest/index.html" target="_blank">official documentation</a></li>
            <li><a href="https://kajahno.me/" target="_blank">about me</a></li>
        </ul>
    </div>

  <a class="DocSite-nav" href="/" style="padding-bottom: 30px;">
      
    <!-- <img class="DocSiteNav-logo"
      src="../../static/images/logo_invert.png"
      alt="Ansible Logo"> -->
    <!-- <div class="DocSiteNav-title">
      kajahno
    </div> -->
  </a>


  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

      <div style="background-color:#5bbdbf;height=80px;margin:'auto auto auto auto'">
        <a class="DocSiteProduct-header DocSiteProduct-header--core" href="/ansible-tutorial/">
            <div class="DocSiteProduct-productName">
                <div class="DocSiteProduct-logoText">
                    Quickstart Tutorial  
                    <div class="DocSiteProduct-CurrentVersion" align="right">
                      Updated on Jan 27, 2019
                    </div>
                </div>
            </div>
        </a>

          <!-- <div class="DocSiteProduct-CheckVersionPara">For previous versions, see the  <a class="DocSiteProduct-versionheader" href="/#coreversionselect">documentation archive.</a></div> -->
      </div>

      <div class="wy-side-nav-search" style="background-color#5bbdbf;height=80px;margin:'auto auto auto auto'">
      <!-- <a href="../../index.html" class="icon icon-home"> Ansible Quickstart Tutorial</a> -->
      
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    </div>

    
          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Prerequisites</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prerequisites/prerequisites.html">Prerequisites</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#create-a-virtual-environment">Create a virtual environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#activate-a-virtual-environment">Activate a virtual environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#install-ansible">Install Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#install-vagrant">Install Vagrant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#references">References</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_playbook.html">Best practices and first playbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="1_playbook.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_playbook.html#create-a-role-to-provision-the-popular-nginx-webserver-with-a-sample-page">Create a role to provision the popular nginx webserver with a sample page</a><ul>
<li class="toctree-l3"><a class="reference internal" href="1_playbook.html#basic-directory-structure">Basic directory structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="1_playbook.html#main-yml">main.yml</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="1_playbook.html#create-a-playbook-to-use-the-role">Create a playbook to use the role</a><ul>
<li class="toctree-l3"><a class="reference internal" href="1_playbook.html#creating-a-server-using-vagrant">Creating a server using Vagrant</a></li>
<li class="toctree-l3"><a class="reference internal" href="1_playbook.html#simple-inventory-file">Simple inventory file</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="1_playbook.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Handling the inventory</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introdution">Introdution</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hosts-management">Hosts management</a></li>
<li class="toctree-l3"><a class="reference internal" href="#variables-management">Variables management</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#variable-precedence">Variable precedence</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#clean-up-the-inventory-file">Clean-up the inventory file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-the-variable-files">Create the variable files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-playbook-again">Run the playbook again</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-inventories">Multiple inventories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#inventory-layout-1-multiple-environments">Inventory layout 1: multiple environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inventory-layout-2-multiple-environments-multiple-customers-or-deployments">Inventory layout 2: multiple environments, multiple customers or deployments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#vault-and-secrets">Vault and secrets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#encrypt-file">Encrypt file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#decrypt-file">Decrypt file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#same-run-command-for-the-playbook">Same run command for the playbook</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-asking-for-the-secrets-password">Run asking for the secrets password</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-using-a-file-with-the-vault-password-in-it">Run using a file with the vault password in it</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-using-the-vault-password-file-environment-variable">Run using the vault password file environment variable</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
            <!-- changeable widget -->

      </div>
      &nbsp;
    </nav>
      </div>


    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Ansible Quickstart Tutorial</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">

          <ul class="wy-breadcrumbs">
  <li><a href="../../index.html">Docs</a> &raquo;</li>
  <li><a href="">Handling the inventory</a></li>
  
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/kajahno/ansible-tutorial/edit/master/source/md/tutorial/2_inventory.md?description=%3C!---%20Your%20description%20here%20--%3E%0A%0A%2Blabel:%20docsite_pr" class="icon icon-github"> Edit on GitHub</a>
    </li>
  
</ul>
<hr/>

          <div id="page-content">
          
  <div class="section" id="handling-the-inventory">
<h1>Handling the inventory<a class="headerlink" href="#handling-the-inventory" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introdution">
<h2>Introdution<a class="headerlink" href="#introdution" title="Permalink to this headline">¶</a></h2>
<p>This section will cover how to work with static inventory files. <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html#intro-dynamic-inventory">Dynamic inventory files</a> are out of this scope.</p>
<p>When working with inventory files, regardless of the type, there are two main abstractions to consider: hosts management and variables management.</p>
<div class="section" id="hosts-management">
<h3>Hosts management<a class="headerlink" href="#hosts-management" title="Permalink to this headline">¶</a></h3>
<p>Inside the inventory file there can be groups, groups of groups, and variables. Since the variable precedence in Ansible is quite complex, we will handle the variables separately. There are many formats for a valid inventory file (depending on the inventory plugin being used). In this case we will focus in the INI-like format, since I believe it’s the easiest to work with when dealing with static inventories.</p>
<p>Consider the following content in the inventory file (taken from <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#groups-of-groups-and-group-variables">here</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">atlanta</span><span class="p">]</span>
<span class="n">host1</span>
<span class="n">host2</span>

<span class="p">[</span><span class="n">raleigh</span><span class="p">]</span>
<span class="n">host2</span>
<span class="n">host3</span>

<span class="p">[</span><span class="n">southeast</span><span class="p">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">atlanta</span>
<span class="n">raleigh</span>
</pre></div>
</div>
<p>In any inventory file there are two default groups: all (includes all of the hosts), and none (includes none of the hosts).</p>
<p>This means that when defining a playbook we can target the right hostgroup in the <code class="docutils literal notranslate"><span class="pre">hosts</span></code> section. Also we can target <code class="docutils literal notranslate"><span class="pre">all</span></code>, and then <code class="docutils literal notranslate"><span class="pre">limit</span></code> to the group of interest we want, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span> <span class="n">any_playbook_with_all_hosts</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">limit</span> <span class="n">atlanta</span>
</pre></div>
</div>
<p>In our case let’s create an inventory file in the following path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">~/</span><span class="n">ansible</span><span class="o">/</span><span class="n">inventory</span>
<span class="n">touch</span> <span class="o">~/</span><span class="n">ansible</span><span class="o">/</span><span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span>
</pre></div>
</div>
</div>
<div class="section" id="variables-management">
<h3>Variables management<a class="headerlink" href="#variables-management" title="Permalink to this headline">¶</a></h3>
<p>This section covers the handling of variables within our inventory. These variables include: variables precedence handling and secrets (such as encrypted files to store passwords)</p>
</div>
</div>
<div class="section" id="variable-precedence">
<h2>Variable precedence<a class="headerlink" href="#variable-precedence" title="Permalink to this headline">¶</a></h2>
<p>In Ansible there is a quite extended <a class="reference external" href="https://gist.github.com/ekreutz/301c3d38a50abbaad38e638d8361a89e">variable precedence</a>. I have found that the easiest ones to work with are as shown below:</p>
<ul class="simple">
<li>inventory/group_vars/all/</li>
<li>inventory/group_vars/group1/</li>
<li>inventory/host_vars/host1</li>
<li>roles/role1/defaults/</li>
<li>roles/role1/vars/</li>
<li>group_vars/all/</li>
<li>–extra-vars (always win)</li>
</ul>
<p>Now we will refactor the previously created inventory file to take advantage of this.</p>
<div class="section" id="clean-up-the-inventory-file">
<h3>Clean-up the inventory file<a class="headerlink" href="#clean-up-the-inventory-file" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Make sure the following content is in the file <code class="docutils literal notranslate"><span class="pre">~/ansible/inventory/hosts</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">nginx_webservers</span><span class="p">]</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="create-the-variable-files">
<h3>Create the variable files<a class="headerlink" href="#create-the-variable-files" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Create the general group_vars file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">group_vars</span><span class="o">/</span><span class="nb">all</span>
<span class="n">touch</span> <span class="n">group_vars</span><span class="o">/</span><span class="nb">all</span><span class="o">/</span><span class="nb">vars</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</li>
<li><p class="first">Make sure the content of <code class="docutils literal notranslate"><span class="pre">group_vars/all/vars.yml</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>

<span class="n">ansible_connection</span><span class="p">:</span> <span class="n">ssh</span>
<span class="n">ansible_ssh_common_args</span><span class="p">:</span> <span class="s1">&#39;-o StrictHostKeyChecking=no&#39;</span>
</pre></div>
</div>
</li>
<li><p class="first">Create the inventory group_vars file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">inventory</span><span class="o">/</span><span class="n">group_vars</span><span class="o">/</span><span class="nb">all</span>
<span class="n">touch</span> <span class="n">inventory</span><span class="o">/</span><span class="n">group_vars</span><span class="o">/</span><span class="nb">all</span><span class="o">/</span><span class="nb">vars</span><span class="o">.</span><span class="n">yml</span>   
</pre></div>
</div>
</li>
<li><p class="first">Make sure the content of <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/all/vars.yml</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>

<span class="n">ansible_ssh_port</span><span class="p">:</span> <span class="mi">22</span>
</pre></div>
</div>
</li>
<li><p class="first">Create the inventory group_vars/group file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">inventory</span><span class="o">/</span><span class="n">group_vars</span><span class="o">/</span><span class="n">nginx_webservers</span>
<span class="n">touch</span> <span class="n">inventory</span><span class="o">/</span><span class="n">group_vars</span><span class="o">/</span><span class="n">nginx_webservers</span><span class="o">/</span><span class="nb">vars</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<blockquote>
<div><p>Te name of this directory must match a group name in the inventory file, otherwise it will be ignored by Ansible</p>
</div></blockquote>
</li>
<li><p class="first">Make sure the content of <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/nginx_webservers/vars.yml</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>

<span class="n">ansible_ssh_port</span><span class="p">:</span> <span class="mi">2222</span>
<span class="n">ansible_user</span><span class="p">:</span> <span class="n">vagrant</span>
<span class="n">ansible_ssh_pass</span><span class="p">:</span> <span class="n">vagrant</span>
</pre></div>
</div>
<blockquote>
<div><p>Notice how we are overriding the <code class="docutils literal notranslate"><span class="pre">ansible_ssh_port</span></code> specified as 22 in the more general vars file. This is to show that the precedence is maintained.</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="run-the-playbook-again">
<h3>Run the playbook again<a class="headerlink" href="#run-the-playbook-again" title="Permalink to this headline">¶</a></h3>
<p>Same as shown at the end of part to, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span> 
</pre></div>
</div>
<p>The output should be the same.</p>
</div>
</div>
<div class="section" id="multiple-inventories">
<h2>Multiple inventories<a class="headerlink" href="#multiple-inventories" title="Permalink to this headline">¶</a></h2>
<p>It’s a common design pattern to support several environments using Ansible. The final layout of the inventory will depend on how you handle your customers, or how many products you deploy on each environment. Let’s evaluate two main layouts.</p>
<div class="section" id="inventory-layout-1-multiple-environments">
<h3>Inventory layout 1: multiple environments<a class="headerlink" href="#inventory-layout-1-multiple-environments" title="Permalink to this headline">¶</a></h3>
<p>Consider the following inventory layout:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>inventory
├── prod
│   ├── group_vars
│   │   ├── all
│   │   │   └── vars.yml
│   │   └── nginx_webservers
│   │       └── vars.yml
│   └── hosts
├── qa
│   ├── group_vars
│   │   ├── all
│   │   │   └── vars.yml
│   │   └── nginx_webservers
│   │       └── vars.yml
│   └── hosts
└── uat
    ├── group_vars
    │   ├── all
    │   │   └── vars.yml
    │   └── nginx_webservers
    │       └── vars.yml
    └── hosts
group_vars
└── all
    └── vars.yml
</pre></div>
</div>
<p>In this layout we see how we define different environments by just wrapping our single inventory into a folder. Variables that apply to all environments can be specified in the <code class="docutils literal notranslate"><span class="pre">group_vars/all/vars.yml</span></code> that is located in the same hierarchy as the <code class="docutils literal notranslate"><span class="pre">inventory</span></code> directory. We can then specify variables specific for each environment, but for all groups, in the files <code class="docutils literal notranslate"><span class="pre">inventory/[prod,</span> <span class="pre">qa,</span> <span class="pre">or</span> <span class="pre">uat]/group_vars/all/vars.yml</span></code> (maybe different credentials per environment). Similarly, we can define variables specifically for the hostgroups, in the files <code class="docutils literal notranslate"><span class="pre">inventory/[prod,</span> <span class="pre">qa,</span> <span class="pre">or</span> <span class="pre">uat]/group_vars/[hostgroup]/vars.yml</span></code>. We could also add the <code class="docutils literal notranslate"><span class="pre">hostvars</span></code> in parallel to the <code class="docutils literal notranslate"><span class="pre">group_vars</span></code>, but since that’s a bit tedious, you might want to automate that task.</p>
<p>A variation of this layout is the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>inventory
├── group_vars
│   ├── all
│   │   └── vars.yml
│   ├── nginx_webservers
│   │   └── vars.yml
│   ├── prod
│   │   └── vars.yml
│   ├── qa
│   │   └── vars.yml
│   └── uat
│       └── vars.yml
├── hosts-prod
├── hosts-qa
└── hosts-uat
group_vars
└── all
    └── vars.yml
</pre></div>
</div>
<p>At the end of the day the decision of the type of inventory will depend on the actual problem you’re trying to solve. Just keep in mind that this is very flexible, and that the variable precedence levels can come very handy.</p>
</div>
<div class="section" id="inventory-layout-2-multiple-environments-multiple-customers-or-deployments">
<h3>Inventory layout 2: multiple environments, multiple customers or deployments<a class="headerlink" href="#inventory-layout-2-multiple-environments-multiple-customers-or-deployments" title="Permalink to this headline">¶</a></h3>
<p>Consider the following inventory layout:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>inventory/
├── customer1
│   ├── group_vars
│   │   ├── all
│   │   │   └── vars.yml
│   │   ├── nginx_webservers
│   │   │   └── vars.yml
│   │   ├── prod
│   │   │   └── vars.yml
│   │   ├── qa
│   │   │   └── vars.yml
│   │   └── uat
│   │       └── vars.yml
│   ├── hosts-prod
│   ├── hosts-qa
│   └── hosts-uat
├── customer2
│   ├── group_vars
│   │   ├── all
│   │   │   └── vars.yml
│   │   ├── nginx_webservers
│   │   │   └── vars.yml
│   │   ├── prod
│   │   │   └── vars.yml
│   │   ├── qa
│   │   │   └── vars.yml
│   │   └── uat
│   │       └── vars.yml
│   ├── hosts-prod
│   ├── hosts-qa
│   └── hosts-uat
└── customer3
    ├── group_vars
    │   ├── all
    │   │   └── vars.yml
    │   ├── nginx_webservers
    │   │   └── vars.yml
    │   ├── prod
    │   │   └── vars.yml
    │   ├── qa
    │   │   └── vars.yml
    │   └── uat
    │       └── vars.yml
    ├── hosts-prod
    ├── hosts-qa
    └── hosts-uat
group_vars
└── all
    └── vars.yml
</pre></div>
</div>
<p>It is pretty much the same as the last example of the multiple environments section, just with another level of wrapping.</p>
<br/>
<br/><p>For our purposes we’ll keep using the simple layout: a single customer, single environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>inventory
├── group_vars
│   ├── all
│   │   └── vars.yml
│   └── nginx_webservers
│       └── vars.yml
└── hosts
group_vars
└── all
    └── vars.yml
</pre></div>
</div>
<p>Let’s talk about secrets now!</p>
</div>
</div>
<div class="section" id="vault-and-secrets">
<h2>Vault and secrets<a class="headerlink" href="#vault-and-secrets" title="Permalink to this headline">¶</a></h2>
<p>Ansible includes a tool that enables the encryption/decryption of files, making it very convenient to work with secrets. This tool is called <a class="reference external" href="https://docs.ansible.com/ansible/2.5/user_guide/vault.html">Ansible Vault</a>.</p>
<p>Normally makes more sense to just encrypt the files that contain sensitive data. However, with Ansible Vault you can encrypt any file.</p>
<p>The Ansible Vault has many features. In this tutorial we’ll just focus on encryption and decryption of files as normally this is enough to get started.</p>
<div class="section" id="encrypt-file">
<h3>Encrypt file<a class="headerlink" href="#encrypt-file" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">encrypt</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">file</span>
</pre></div>
</div>
<blockquote>
<div>By default if there are no saved passwords, the tool will prompt for a new password to be entered.</div></blockquote>
</div>
<div class="section" id="decrypt-file">
<h3>Decrypt file<a class="headerlink" href="#decrypt-file" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">decrypt</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">file</span>
</pre></div>
</div>
<br/>
In our case we will modify the ssh password from a file, to an encrypted file. To achieve this please do:<ul>
<li><p class="first">Make sure the content of the file <code class="docutils literal notranslate"><span class="pre">ansible/inventory/group_vars/nginx_webservers/vars.yml</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>

<span class="n">ansible_ssh_port</span><span class="p">:</span> <span class="mi">2222</span>
<span class="n">ansible_user</span><span class="p">:</span> <span class="n">vagrant</span>
</pre></div>
</div>
</li>
<li><p class="first">Create the vault file for the host group <code class="docutils literal notranslate"><span class="pre">nginx_webservers</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">ansible</span><span class="o">/</span><span class="n">inventory</span><span class="o">/</span><span class="n">group_vars</span><span class="o">/</span><span class="n">nginx_webservers</span><span class="o">/</span><span class="n">vault</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</li>
<li><p class="first">Make sure the content of the file <code class="docutils literal notranslate"><span class="pre">ansible/inventory/group_vars/nginx_webservers/vault.yml</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>


<span class="n">ansible_ssh_pass</span><span class="p">:</span> <span class="n">vagrant</span>
</pre></div>
</div>
</li>
<li><p class="first">Encrypt the vault file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">encrypt</span> <span class="n">inventory</span><span class="o">/</span><span class="n">group_vars</span><span class="o">/</span><span class="n">nginx_webservers</span><span class="o">/</span><span class="n">vault</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<blockquote>
<div><p>You should see <code class="docutils literal notranslate"><span class="pre">Encryption</span> <span class="pre">successful</span></code> as a result of the operation. Remember this password!</p>
</div></blockquote>
</li>
<li><p class="first">Verify the content of the now encrypted file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="n">ansible</span><span class="o">/</span><span class="n">inventory</span><span class="o">/</span><span class="n">group_vars</span><span class="o">/</span><span class="n">nginx_webservers</span><span class="o">/</span><span class="n">vault</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<blockquote>
<div><p>You should see the file with some encrypted pattern</p>
</div></blockquote>
</li>
</ul>
<p>After doing this we can run again the playbook as usual.</p>
</div>
<div class="section" id="same-run-command-for-the-playbook">
<h3>Same run command for the playbook<a class="headerlink" href="#same-run-command-for-the-playbook" title="Permalink to this headline">¶</a></h3>
<p>Command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>The output should be an error:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>PLAY [all] ***************************************************************************************************************************************************************************************************************************
ERROR! Attempting to decrypt but no vault secrets found
</pre></div>
</div>
</div>
<div class="section" id="run-asking-for-the-secrets-password">
<h3>Run asking for the secrets password<a class="headerlink" href="#run-asking-for-the-secrets-password" title="Permalink to this headline">¶</a></h3>
<p>Command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">ask</span><span class="o">-</span><span class="n">vault</span><span class="o">-</span><span class="k">pass</span>
</pre></div>
</div>
<p>The output should prompt for the decryption password. After the playbook should run successfuly.</p>
</div>
<div class="section" id="run-using-a-file-with-the-vault-password-in-it">
<h3>Run using a file with the vault password in it<a class="headerlink" href="#run-using-a-file-with-the-vault-password-in-it" title="Permalink to this headline">¶</a></h3>
<p>Create a file and store the password in it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;YOU_PASSWORD_HERE&quot;</span> <span class="o">&gt;</span> <span class="n">vaultPasswordFile</span>
</pre></div>
</div>
<p>Run the playbook specifying the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">vault</span><span class="o">-</span><span class="n">password</span><span class="o">-</span><span class="n">file</span> <span class="o">./</span><span class="n">vaultPasswordFile</span>
</pre></div>
</div>
<p>The playbook should run successfuly.</p>
</div>
<div class="section" id="run-using-the-vault-password-file-environment-variable">
<h3>Run using the vault password file environment variable<a class="headerlink" href="#run-using-the-vault-password-file-environment-variable" title="Permalink to this headline">¶</a></h3>
<p>Export the location of the password file as an environment variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">ANSIBLE_VAULT_PASSWORD_FILE</span><span class="o">=</span><span class="n">absolute</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">vaultPasswordFile</span>
</pre></div>
</div>
<p>Run the playbook without specifying the vault password file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">inventory</span><span class="o">/</span><span class="n">hosts</span> <span class="n">webservers</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>The playbook should run successfly.</p>
<br/><p>Until here you have the knowledge to spin up Ansible, and configure it according to your requirements. It is true that the role we just created was very simple, however there is extended documentation regarding roles, specially using <a class="reference external" href="https://galaxy.ansible.com/">Ansible Galaxy</a>, which won’t be cover in this tutorial.</p>
<p>Let’s get to know more about Ansible in the next modules!</p>
</div>
</div>
</div>


          </div>
          <div id="search-results"><gcse:searchresults-only></div>
          <footer>
  
    <div class="rst-footer-buttons">
      
      
        <a href="1_playbook.html" class="btn btn-neutral" title="Best practices and first playbook"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','yABGvz2N8PwcwBxyfzUc','2.0.0');
</script>

  <p>
  Last updated on Jan 27, 2019. <br/>
  </p>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../static/jquery.js"></script>
      <script type="text/javascript" src="../../static/underscore.js"></script>
      <script type="text/javascript" src="../../static/doctools.js"></script>
      <script type="text/javascript" src="../../static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../../static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 
<!-- begin analytics -->
<script type="text/javascript">
var _hsq = _hsq || [];
_hsq.push(["setContentType", "standard-page"]);
        (function(d,s,i,r) {
        if (d.getElementById(i)){return;}
        var n = d.createElement(s),e = document.getElementsByTagName(s)[0];
        n.id=i;n.src = '//js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/330046.js';
        e.parentNode.insertBefore(n, e);
        })(document, "script", "hs-analytics",300000);
</script>
<!-- end analytics -->
<script type="text/javascript">
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
_satellite.pageBottom();
}
</script>
</body>
</html>