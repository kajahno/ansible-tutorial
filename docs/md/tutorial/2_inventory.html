

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-128617327-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-128617327-1');
  </script>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta class="swiftype" name="published_at" data-type="date" content="2017-12-13" /> 
  <meta class="swiftype" name="version" data-type="string" content="3.2.2">


  
  <title>2 - Handling the inventory &mdash; Ansible Quickstart Tutorial 0.0.1 documentation</title>
  

  
  
  
  

  
    <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../../',
        VERSION:'0.0.1',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../../static/jquery.js"></script>
      <script type="text/javascript" src="../../static/underscore.js"></script>
      <script type="text/javascript" src="../../static/doctools.js"></script>
      <script type="text/javascript" src="../../static/language_data.js"></script>

    

  

  
    <link rel="stylesheet" href="../../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../static/theme-overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3 - Working with modules and roles" href="3_modules_and_roles.html" />
    <link rel="prev" title="1 - Best practices and first playbook" href="1_playbook.html" /> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>


  
  <script src="../../static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav"> 

    <div class="DocSite-globalNav ansibleNav">
        <ul>
            <li><a href="https://docs.ansible.com/ansible/latest/index.html" target="_blank">official documentation</a></li>
            <li><a href="https://kajahno.me/" target="_blank">about me</a></li>
        </ul>
    </div>

  <a class="DocSite-nav" href="/ansible-tutorial/" style="padding-bottom: 30px;">
      
    <!-- <img class="DocSiteNav-logo"
      src="../../static/images/logo_invert.png"
      alt="Ansible Logo"> -->
    <div class="DocSiteNav-title">
      Ansible
    </div>
  </a>


  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

      <div style="background-color:#00b8d4;height=80px;margin:'auto auto auto auto'">
        <a class="DocSiteProduct-header DocSiteProduct-header--core" href="/ansible-tutorial/">
            <div class="DocSiteProduct-productName">
                <div class="DocSiteProduct-logoText">
                    Quickstart Tutorial  
                    <div class="DocSiteProduct-CurrentVersion" align="right">
                      Updated on Jun 13, 2020
                    </div>
                </div>
            </div>
        </a>

          <!-- <div class="DocSiteProduct-CheckVersionPara">For previous versions, see the  <a class="DocSiteProduct-versionheader" href="/#coreversionselect">documentation archive.</a></div> -->
      </div>

      <div class="wy-side-nav-search" style="background-color#00b8d4;height=80px;margin:'auto auto auto auto'">
      <!-- <a href="../../index.html" class="icon icon-home"> Ansible Quickstart Tutorial</a> -->
      
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search in this site" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
    </div>

    
          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">What is Ansible?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction.html#agentless">Agentless</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction.html#expansion-of-the-tool">Expansion of the tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction.html#declarative-vs-imperative-model">Declarative vs Imperative model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction.html#tools-similar-to-ansible">Tools similar to Ansible</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Prerequisites</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../prerequisites/terminology.html">Terminology</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/terminology.html#ansible-playbook">Ansible Playbook</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../prerequisites/terminology.html#basic-directory-structure">Basic directory structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../prerequisites/terminology.html#inventory">Inventory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../prerequisites/terminology.html#ansible-playbook-file">Ansible Playbook file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../prerequisites/terminology.html#plays">Plays</a></li>
<li class="toctree-l3"><a class="reference internal" href="../prerequisites/terminology.html#roles">Roles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../prerequisites/terminology.html#tasks">Tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../prerequisites/terminology.html#module">Module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/terminology.html#ansible-ad-hoc">Ansible ad-hoc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../prerequisites/prerequisites.html">Prerequisites</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#create-a-virtual-environment">Create a virtual environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#activate-a-virtual-environment">Activate a virtual environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../prerequisites/prerequisites.html#deactivate-a-virtual-environment">Deactivate a virtual environment</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#install-ansible-inside-a-python-virtual-environment">Install Ansible (inside a Python virtual environment)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#install-virtualbox">Install VirtualBox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#install-vagrant">Install Vagrant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../prerequisites/prerequisites.html#references">References</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_playbook.html">1 - Best practices and first playbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="1_playbook.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_playbook.html#create-a-role-to-provision-the-popular-nginx-webserver-with-a-sample-page">Create a role to provision the popular nginx webserver with a sample page</a><ul>
<li class="toctree-l3"><a class="reference internal" href="1_playbook.html#role-webservers-nginx">Role <code class="docutils literal notranslate"><span class="pre">webservers-nginx</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="1_playbook.html#create-a-playbook-to-use-the-role">Create a playbook to use the role</a><ul>
<li class="toctree-l3"><a class="reference internal" href="1_playbook.html#creating-a-virtual-machine-using-vagrant">Creating a virtual machine using Vagrant</a><ul>
<li class="toctree-l4"><a class="reference internal" href="1_playbook.html#how-to-ssh-into-a-vagrant-vm">How to SSH into a Vagrant VM</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="1_playbook.html#simple-inventory-file">Simple inventory file</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="1_playbook.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2 - Handling the inventory</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hosts-management">Hosts management</a></li>
<li class="toctree-l3"><a class="reference internal" href="#variables-management">Variables management</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#variable-precedence">Variable precedence</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cleaning-up-the-current-inventory-file">Cleaning-up the current inventory file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-files-to-place-variables">Create files to place variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-the-vagrant-box">Create the vagrant box</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-playbook">Run the playbook</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#multiple-inventories">Multiple inventories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#inventory-layout-1-multiple-environments">Inventory layout 1: multiple environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inventory-layout-2-multiple-environments-multiple-customers-or-deployments">Inventory layout 2: multiple environments, multiple customers or deployments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#vault-and-secrets">Vault and secrets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#encrypt-a-file">Encrypt a file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#decrypt-file">Decrypt file</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#including-vault-into-our-environment">Including vault into our environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#run-playbook-using-the-usual-command">Run playbook using the usual command</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-playbook-asking-for-the-vault-password">Run playbook asking for the vault password</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#verify-htpasswd-file">Verify htpasswd file</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#run-using-a-file-with-the-vault-password-in-it">Run using a file with the vault password in it</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-using-the-vault-password-file-environment-variable">Run using the vault password file environment variable</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bonus-specify-the-ansible-vault-password-file-var-without-exporting-it">Bonus: specify the ANSIBLE_VAULT_PASSWORD_FILE var without exporting it</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="3_modules_and_roles.html">3 - Working with modules and roles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="3_modules_and_roles.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_modules_and_roles.html#roles">Roles</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_modules_and_roles.html#modules">Modules</a></li>
</ul>
</li>
</ul>

            
          
        </div>
            <!-- changeable widget -->

      </div>
      &nbsp;
    </nav>
      </div>


    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Ansible Quickstart Tutorial</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">

          <ul class="wy-breadcrumbs">
  <li><a href="../../index.html">Docs</a> &raquo;</li>
  <li><a href="">2 - Handling the inventory</a></li>
  
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/kajahno/ansible-tutorial/edit/master/source/md/tutorial/2_inventory.md?description=%3C!---%20Your%20description%20here%20--%3E%0A%0A%2Blabel:%20docsite_pr" class="icon icon-github"> Edit on GitHub</a>
    </li>
  
</ul>
<hr/>

          <div id="page-content">
          
  <div class="section" id="handling-the-inventory">
<h1>2 - Handling the inventory<a class="headerlink" href="#handling-the-inventory" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This section will cover how to work with static inventory files. <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/intro_dynamic_inventory.html#intro-dynamic-inventory">Dynamic inventory files</a> are out of this scope.</p>
<p>When working with inventory files, regardless of the type, there are two main abstractions to consider: hosts management and variables management.</p>
<div class="section" id="hosts-management">
<h3>Hosts management<a class="headerlink" href="#hosts-management" title="Permalink to this headline">¶</a></h3>
<p>Inside the inventory file there can be groups, groups of groups, and variables. Since the variable precedence in Ansible is quite complex, we will handle the variables separately. There are many formats for a valid inventory file (depending on the inventory plugin being used). In this case we will focus in the INI-like format, since I believe it’s the easiest to work with when dealing with static inventories.</p>
<p>Consider the following content in the inventory file (taken from <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#groups-of-groups-and-group-variables">here</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">atlanta</span><span class="p">]</span>
<span class="n">host1</span>
<span class="n">host2</span>

<span class="p">[</span><span class="n">raleigh</span><span class="p">]</span>
<span class="n">host2</span>
<span class="n">host3</span>

<span class="p">[</span><span class="n">southeast</span><span class="p">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">atlanta</span>
<span class="n">raleigh</span>
</pre></div>
</div>
<p>In any inventory file there are two default groups: <code class="docutils literal notranslate"><span class="pre">all</span></code> (includes all of the hosts), and <code class="docutils literal notranslate"><span class="pre">none</span></code> (includes none of the hosts).</p>
<p>When defining a playbook we can target the right hostgroup in the <code class="docutils literal notranslate"><span class="pre">hosts</span></code> section. Also, we can target the hostgroup <code class="docutils literal notranslate"><span class="pre">all</span></code>, and then <code class="docutils literal notranslate"><span class="pre">limit</span></code> to the group of interest we want when running our playbook, like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> $ ansible-playbook -i inventory/hosts any_playbook_with_all_hosts.yml --limit atlanta
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Don’t actually run that. It’s just to illustrate how the command would be structured.</p>
</div>
<p>In our case let’s create an empty inventory file in the following path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(.venv) $ mkdir -p ~/ansible_2/inventory
(.venv) $ touch ~/ansible_2/inventory/hosts
</pre></div>
</div>
<p>Let’s include the following content (yes, same file from part 1):</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">nginx_webservers</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">10.100.0.2</span>

<span class="l l-Scalar l-Scalar-Plain">[all:vars]</span>
<span class="l l-Scalar l-Scalar-Plain">ansible_connection=ssh</span>
<span class="l l-Scalar l-Scalar-Plain">ansible_user=vagrant</span>
<span class="l l-Scalar l-Scalar-Plain">ansible_ssh_private_key_file=.vagrant/machines/default/virtualbox/private_key</span>
<span class="l l-Scalar l-Scalar-Plain">ansible_ssh_common_args=&#39;-o StrictHostKeyChecking=no&#39;</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
<p>Also create the role we’ll use in this section (again, same role from part 1):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(.venv) $ mkdir -p ~/ansible_2/roles/webservers-nginx/tasks/
(.venv) $ touch ~/ansible_2/roles/webservers-nginx/tasks/main.yml
</pre></div>
</div>
<p>Content is:</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">install the nginx reverse proxy</span>
  <span class="nt">apt</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">update_cache</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable nginx service</span>
  <span class="nt">systemd</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
</div>
<div class="section" id="variables-management">
<h3>Variables management<a class="headerlink" href="#variables-management" title="Permalink to this headline">¶</a></h3>
<p>This section covers the use of variables by our inventory (and playbooks). The areas covered are: variables precedence and secrets via the usage of ansible-vault files (encrypted files to conveniently place secrets)</p>
</div>
</div>
<div class="section" id="variable-precedence">
<h2>Variable precedence<a class="headerlink" href="#variable-precedence" title="Permalink to this headline">¶</a></h2>
<p>In Ansible there is a quite extensive <a class="reference external" href="https://gist.github.com/ekreutz/301c3d38a50abbaad38e638d8361a89e">variable precedence list</a>. I have found that the easiest ones to work with are as shown below (the higher the number, the higher the precedence):</p>
<ol class="simple">
<li>inventory/group_vars/all/</li>
<li>inventory/group_vars/group1/</li>
<li>inventory/host_vars/host1</li>
<li>roles/role1/defaults/</li>
<li>roles/role1/vars/</li>
<li>group_vars/all/</li>
<li><code class="docutils literal notranslate"><span class="pre">--extra-vars</span></code> (always wins)</li>
</ol>
<p>Now we will refactor the previously created inventory file to take advantage of this.</p>
<div class="section" id="cleaning-up-the-current-inventory-file">
<h3>Cleaning-up the current inventory file<a class="headerlink" href="#cleaning-up-the-current-inventory-file" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Make sure the following content is in the file <code class="docutils literal notranslate"><span class="pre">~/ansible_2/inventory/hosts.ini</span></code>:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">nginx_webservers</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">10.100.0.2</span>
</pre></div>
</td></tr></table></div>
</li>
</ul>
</div>
<div class="section" id="create-files-to-place-variables">
<h3>Create files to place variables<a class="headerlink" href="#create-files-to-place-variables" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Create a global group_vars file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ mkdir -p group_vars/all
<span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ touch group_vars/all/vars.yml
</pre></div>
</div>
</li>
<li><p class="first">Make sure the content of <code class="docutils literal notranslate"><span class="pre">group_vars/all/vars.yml</span></code> is:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="nt">ansible_connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh</span>
<span class="nt">ansible_ssh_common_args</span><span class="p">:</span> <span class="s">&#39;-o</span><span class="nv"> </span><span class="s">StrictHostKeyChecking=no&#39;</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">Create the inventory-level group_vars file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ mkdir -p inventory/group_vars/all
<span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ touch inventory/group_vars/all/vars.yml
</pre></div>
</div>
</li>
<li><p class="first">Make sure the content of <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/all/vars.yml</span></code> is:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="nt">ansible_ssh_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2200</span>
<span class="nt">ansible_connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh</span>
<span class="nt">ansible_ssh_common_args</span><span class="p">:</span> <span class="s">&#39;-o</span><span class="nv"> </span><span class="s">StrictHostKeyChecking=no&#39;</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">Create the inventory group_vars/<code class="docutils literal notranslate"><span class="pre">GROUP_NAME</span></code> vars file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ mkdir -p inventory/group_vars/nginx_webservers
<span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ touch inventory/group_vars/nginx_webservers/vars.yml
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The name of this directory must match a hostgroup inside the inventory file</p>
</div>
</li>
<li><p class="first">Make sure the content of <code class="docutils literal notranslate"><span class="pre">inventory/group_vars/nginx_webservers/vars.yml</span></code> is:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="nt">ansible_ssh_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">22</span>
<span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vagrant</span>
<span class="nt">ansible_ssh_private_key_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.vagrant/machines/default/virtualbox/private_key</span>

<span class="nt">simple_auth_username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
</pre></div>
</td></tr></table></div>
</li>
</ul>
</div>
<div class="section" id="create-the-vagrant-box">
<h3>Create the vagrant box<a class="headerlink" href="#create-the-vagrant-box" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Initialize vagrant with an ubuntu image:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ~/ansible_2 $ vagrant init bento/ubuntu-16.04 --minimal
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This will create the file ‘Vagrantfile’.</p>
</div>
</li>
<li><p class="first">Open the auto-generated <code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code>, and make sure the content looks like this:</p>
<div class="highlight-ruby notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">2200</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;bento/ubuntu-16.04&quot;</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.100.0.2&quot;</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;tutorial-2&quot;</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">Start the virtual machine</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ~/ansible_2 $ vagrant up
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Time to get a cup of tea while this is done.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="run-the-playbook">
<h3>Run the playbook<a class="headerlink" href="#run-the-playbook" title="Permalink to this headline">¶</a></h3>
<p>Similar to part 1, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(.venv) ~/ansible_2 $ ansible-playbook -i inventory/hosts.ini webservers.yml
</pre></div>
</div>
<p>The output should be:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="n">PLAY</span> <span class="p">[</span><span class="n">nginx_webservers</span><span class="p">]</span> <span class="o">************************************************************************************************************************************************</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">Gathering</span> <span class="n">Facts</span><span class="p">]</span> <span class="o">*************************************************************************************************************************************************</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>

<span class="n">TASK</span> <span class="p">[</span><span class="n">webservers</span><span class="o">-</span><span class="n">nginx</span> <span class="p">:</span> <span class="n">install</span> <span class="n">the</span> <span class="n">nginx</span> <span class="n">reverse</span> <span class="n">proxy</span><span class="p">]</span> <span class="o">**************************************************************************************************************</span>
<span class="hll"><span class="n">changed</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>
</span>
<span class="n">TASK</span> <span class="p">[</span><span class="n">webservers</span><span class="o">-</span><span class="n">nginx</span> <span class="p">:</span> <span class="n">enable</span> <span class="n">nginx</span> <span class="n">service</span><span class="p">]</span> <span class="o">*************************************************************************************************************************</span>
<span class="n">ok</span><span class="p">:</span> <span class="p">[</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">]</span>

<span class="n">PLAY</span> <span class="n">RECAP</span> <span class="o">*************************************************************************************************************************************************************</span>
<span class="hll"><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>                  <span class="p">:</span> <span class="n">ok</span><span class="o">=</span><span class="mi">3</span>    <span class="n">changed</span><span class="o">=</span><span class="mi">1</span>    <span class="n">unreachable</span><span class="o">=</span><span class="mi">0</span>    <span class="n">failed</span><span class="o">=</span><span class="mi">0</span>   
</span>
</pre></div>
</td></tr></table></div>
<p>In conclusion, same desired result as in part 1, but now using a nice layout for the inventory.</p>
</div>
</div>
<div class="section" id="multiple-inventories">
<h2>Multiple inventories<a class="headerlink" href="#multiple-inventories" title="Permalink to this headline">¶</a></h2>
<p>It’s a common design pattern to take into consideration order of precedence of the variables in order to create a directory structure that can support several environments easily. The final layout of the inventory will depend on how you handle your customers, or how many products you deploy on each environment. Let’s evaluate two common layouts.</p>
<div class="section" id="inventory-layout-1-multiple-environments">
<h3>Inventory layout 1: multiple environments<a class="headerlink" href="#inventory-layout-1-multiple-environments" title="Permalink to this headline">¶</a></h3>
<p>Consider the following inventory layout:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>inventory
├── prod
│   ├── group_vars
│   │   ├── all
│   │   │   └── vars.yml
│   │   └── nginx_webservers
│   │       └── vars.yml
│   └── hosts
├── qa
│   ├── group_vars
│   │   ├── all
│   │   │   └── vars.yml
│   │   └── nginx_webservers
│   │       └── vars.yml
│   └── hosts
└── uat
    ├── group_vars
    │   ├── all
    │   │   └── vars.yml
    │   └── nginx_webservers
    │       └── vars.yml
    └── hosts
group_vars
└── all
    └── vars.yml
</pre></div>
</div>
<p>In this layout we see how different environments can be defined by just turning our single inventory file into a folder with many small inventories. Things to notice are:</p>
<ul class="simple">
<li>Variables that apply to all environments can be specified in the <code class="docutils literal notranslate"><span class="pre">group_vars/all/vars.yml</span></code> that is located in the same hierarchy as the <code class="docutils literal notranslate"><span class="pre">inventory</span></code> directory</li>
<li>Variables that apply for all groups within an environment, can be specified in the files <code class="docutils literal notranslate"><span class="pre">inventory/[prod,</span> <span class="pre">qa,</span> <span class="pre">or</span> <span class="pre">uat]/group_vars/all/vars.yml</span></code>. Useful for defining endpoints attached to a specific environment, for example.</li>
<li>Variables that apply to a certain hostgroup, in the files <code class="docutils literal notranslate"><span class="pre">inventory/[prod,</span> <span class="pre">qa,</span> <span class="pre">or</span> <span class="pre">uat]/group_vars/[hostgroup]/vars.yml</span></code>. An extension of this approach is to also add the <code class="docutils literal notranslate"><span class="pre">hostvars</span></code> in parallel to the <code class="docutils literal notranslate"><span class="pre">group_vars</span></code>, but since that’s a bit tedious, you might want to automate that task.</li>
</ul>
<p>Another variation of this layout is the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>inventory
├── group_vars
│   ├── all
│   │   └── vars.yml
│   ├── nginx_webservers
│   │   └── vars.yml
│   ├── prod
│   │   └── vars.yml
│   ├── qa
│   │   └── vars.yml
│   └── uat
│       └── vars.yml
├── hosts-prod
├── hosts-qa
└── hosts-uat
group_vars
└── all
    └── vars.yml
</pre></div>
</div>
</div>
<div class="section" id="inventory-layout-2-multiple-environments-multiple-customers-or-deployments">
<h3>Inventory layout 2: multiple environments, multiple customers or deployments<a class="headerlink" href="#inventory-layout-2-multiple-environments-multiple-customers-or-deployments" title="Permalink to this headline">¶</a></h3>
<p>Consider the following inventory layout:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>inventory/
├── customer1
│   ├── group_vars
│   │   ├── all
│   │   │   └── vars.yml
│   │   ├── nginx_webservers
│   │   │   └── vars.yml
│   │   ├── prod
│   │   │   └── vars.yml
│   │   ├── qa
│   │   │   └── vars.yml
│   │   └── uat
│   │       └── vars.yml
│   ├── hosts-prod
│   ├── hosts-qa
│   └── hosts-uat
├── customer2
│   ├── group_vars
│   │   ├── all
│   │   │   └── vars.yml
│   │   ├── nginx_webservers
│   │   │   └── vars.yml
│   │   ├── prod
│   │   │   └── vars.yml
│   │   ├── qa
│   │   │   └── vars.yml
│   │   └── uat
│   │       └── vars.yml
│   ├── hosts-prod
│   ├── hosts-qa
│   └── hosts-uat
└── customer3
    ├── group_vars
    │   ├── all
    │   │   └── vars.yml
    │   ├── nginx_webservers
    │   │   └── vars.yml
    │   ├── prod
    │   │   └── vars.yml
    │   ├── qa
    │   │   └── vars.yml
    │   └── uat
    │       └── vars.yml
    ├── hosts-prod
    ├── hosts-qa
    └── hosts-uat
group_vars
└── all
    └── vars.yml
</pre></div>
</div>
<p>It is pretty much the same as the last example of the multiple environments section, just adding another folder. At the end of the day the decision of the type of inventory layout will depend on the actual problem you’re trying to solve. Just keep in mind that this is very flexible, and that the variable precedence levels can come very handy.</p>
<p>For our purposes we’ll keep using the simple layout: a single environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>inventory
├── group_vars
│   ├── all
│   │   └── vars.yml
│   └── nginx_webservers
│       └── vars.yml
└── hosts
group_vars
└── all
    └── vars.yml
</pre></div>
</div>
<p>Let’s talk about secrets now!</p>
</div>
</div>
<div class="section" id="vault-and-secrets">
<h2>Vault and secrets<a class="headerlink" href="#vault-and-secrets" title="Permalink to this headline">¶</a></h2>
<p>Ansible includes a tool that enables the encryption/decryption of files, making it very convenient to work with secrets. This tool is called <a class="reference external" href="https://docs.ansible.com/ansible/2.5/user_guide/vault.html">Ansible Vault</a>.</p>
<p>Normally makes more sense to just encrypt the files that contain sensitive data. However, with Ansible Vault you can encrypt any file.</p>
<p>The Ansible Vault has many features. In this tutorial we’ll just focus on encryption and decryption of files as normally this is enough to get started.</p>
<div class="section" id="encrypt-a-file">
<h3>Encrypt a file<a class="headerlink" href="#encrypt-a-file" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">encrypt</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">file</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">By default if there are no saved passwords, the tool will prompt for a new password to be entered.</p>
</div>
</div>
<div class="section" id="decrypt-file">
<h3>Decrypt file<a class="headerlink" href="#decrypt-file" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">vault</span> <span class="n">decrypt</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">file</span>
</pre></div>
</div>
<br/>
In our case we will modify the current setup in the following way:<ul class="simple">
<li>We will enable simple HTTP authentication in our nginx server</li>
<li>We will create a vault file to create a variable that will hold the password</li>
<li>We will encrypt that vault file so it’s safely stored in the repository</li>
</ul>
</div>
</div>
<div class="section" id="including-vault-into-our-environment">
<h2>Including vault into our environment<a class="headerlink" href="#including-vault-into-our-environment" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Make sure the content of the file <code class="docutils literal notranslate"><span class="pre">~/ansible_2/roles/webservers-nginx/tasks/main.yml</span></code> is:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="hll"><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">check vars</span>
</span>  <span class="nt">assert</span><span class="p">:</span>
    <span class="nt">that</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">simple_auth_username != &#39;&#39;</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">simple_auth_password != &#39;&#39;</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">install the nginx reverse proxy</span>
  <span class="nt">apt</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">update_cache</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

<span class="hll"><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable nginx service</span>
</span>  <span class="nt">systemd</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

<span class="hll"><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">install python pip</span>
</span>  <span class="nt">apt</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python-pip</span>
    <span class="nt">update_cache</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="hll"><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">install python library &#39;passlib&#39;</span>
</span>  <span class="nt">pip</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">passlib</span>

<span class="hll"><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">create htpasswd for HTTP basic authentication</span>
</span>  <span class="nt">htpasswd</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/nginx/.htpasswd</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">simple_auth_username</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">password</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">simple_auth_password</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">crypt_scheme</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">md5_crypt</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Add basic HTTP authentication configuration on nginx</span>
<span class="hll">  <span class="nt">blockinfile</span><span class="p">:</span>
</span>    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/nginx/sites-available/default</span>
    <span class="nt">marker</span><span class="p">:</span> <span class="s">&quot;</span><span class="nv">        </span><span class="s">####</span><span class="nv"> </span><span class="s">{mark}</span><span class="nv"> </span><span class="s">ANSIBLE</span><span class="nv"> </span><span class="s">MANAGED</span><span class="nv"> </span><span class="s">BLOCK</span><span class="nv"> </span><span class="s">#####&quot;</span>
    <span class="nt">insertafter</span><span class="p">:</span> <span class="s">&#39;^\s+server_name</span><span class="nv"> </span><span class="s">_;&#39;</span>
    <span class="nt">block</span><span class="p">:</span> <span class="p p-Indicator">|</span>
      <span class="no">#</span>
              <span class="no">auth_basic           &quot;Administrator’s Area&quot;;</span>
              <span class="no">auth_basic_user_file /etc/nginx/.htpasswd;</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">reload nginx service</span>
  <span class="nt">systemd</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">reloaded</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The new tasks are highlighted</p>
</div>
<p>Things to notice here are:</p>
<ul class="simple">
<li>The check of variables at the beginning will provide a fail-fast mechanism (won’t run further tasks if the vars are not provided)</li>
<li>Variables are normally rendered by enveloping them between double quotes (lines 33 and 34), and double curly braces (this is a convention from the Python templating engine <a class="reference external" href="http://jinja.pocoo.org/">Jinja</a>)</li>
<li>List of modules used: <a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/assert_module.html">assert</a>, <a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/apt_module.html">apt</a>, <a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/systemd_module.html">systemd</a>, <a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/pip_module.html">pip</a>, <a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/htpasswd_module.html">htpasswd</a>, <a class="reference external" href="https://docs.ansible.com/ansible/latest/modules/blockinfile_module.html">blockinfile</a>.</li>
</ul>
</li>
<li><p class="first">Make sure the content of the file <code class="docutils literal notranslate"><span class="pre">~/ansible_2/roles/webservers-nginx/defaults/main.yml</span></code> is:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="nt">simple_auth_username</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
<span class="nt">simple_auth_password</span><span class="p">:</span> <span class="s">&#39;&#39;</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We give the blank value of the variables, so the role fails fast if the vars are not provided</p>
</div>
</li>
<li><p class="first">Make sure the content of the file <code class="docutils literal notranslate"><span class="pre">~/ansible_2/inventory/group_vars/nginx_webservers/vars.yml</span></code> is:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="nt">ansible_ssh_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">22</span>
<span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vagrant</span>
<span class="nt">ansible_ssh_private_key_file</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.vagrant/machines/default/virtualbox/private_key</span>

<span class="hll"><span class="nt">simple_auth_username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
</span></pre></div>
</td></tr></table></div>
</li>
<li><p class="first">Create the vault file for the host group <code class="docutils literal notranslate"><span class="pre">nginx_webservers</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ touch inventory/group_vars/nginx_webservers/vault.yml
</pre></div>
</div>
</li>
<li><p class="first">Make sure the content of the file <code class="docutils literal notranslate"><span class="pre">~/ansible_2/inventory/group_vars/nginx_webservers/vault.yml</span></code> is:</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="nt">simple_auth_password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">Encrypt the vault file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ ansible-vault encrypt inventory/group_vars/nginx_webservers/vault.yml
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You should see ‘Encryption successful’ as a result of the operation. Remember this password!</p>
</div>
</li>
<li><p class="first">Verify the content of the now encrypted file. You should see a similar output to the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ANSIBLE_VAULT;1.1;AES256</span>
<span class="l l-Scalar l-Scalar-Plain">31386330323961363237313632373938656130306531633263393635373338326564373233643966</span>
<span class="l l-Scalar l-Scalar-Plain">3262626132333530386330393962646639666238326334360a333163663537343336373263643561</span>
<span class="l l-Scalar l-Scalar-Plain">62333366633065343439363539613031393732323031336539636266383132373738613864653334</span>
<span class="l l-Scalar l-Scalar-Plain">6162366130393462360a633362356637373030363737313461356138343736336164393939313363</span>
<span class="l l-Scalar l-Scalar-Plain">61306435633961343435363831346663343936306532393035623831393733643537363161383833</span>
<span class="l l-Scalar l-Scalar-Plain">3734313034336431383463363834636362633032323936323336</span>
</pre></div>
</div>
</li>
</ul>
<p>After doing this we can run again the playbook as usual.</p>
<div class="section" id="run-playbook-using-the-usual-command">
<h3>Run playbook using the usual command<a class="headerlink" href="#run-playbook-using-the-usual-command" title="Permalink to this headline">¶</a></h3>
<p>Command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ ansible-playbook -i inventory/hosts.ini webservers.yml
</pre></div>
</div>
<p>The output should be an error similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>PLAY [all] **************************************************************************************
ERROR! Attempting to decrypt but no vault secrets found
</pre></div>
</div>
</div>
<div class="section" id="run-playbook-asking-for-the-vault-password">
<h3>Run playbook asking for the vault password<a class="headerlink" href="#run-playbook-asking-for-the-vault-password" title="Permalink to this headline">¶</a></h3>
<p>Command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ ansible-playbook -i inventory/hosts.ini webservers.yml --ask-vault-pass
</pre></div>
</div>
<p>Now Ansible will prompt for the vault password. After providing the password, now try to access the local nginx webserver <a class="reference external" href="http://10.100.0.2">http://10.100.0.2</a>. It should prompt using the basic HTTP authentication dialog box (credentials are <code class="docutils literal notranslate"><span class="pre">admin:admin</span></code>), similar to this one:</p>
<div class="rst-figure-alignment figure align-left" id="id1">
<a class="reference internal image-reference" href="../../images/2_2_nginx.png"><img alt="Nginx basic HTTP auth" src="../../images/2_2_nginx.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-text"><strong>Nginx basic HTTP auth</strong></span></p>
</div>
<div class="section" id="verify-htpasswd-file">
<h4>Verify htpasswd file<a class="headerlink" href="#verify-htpasswd-file" title="Permalink to this headline">¶</a></h4>
<p>If you want to verify how this .htpasswd file is looking in the server, you can do so by:</p>
<ul>
<li><p class="first">Running a simple SSH command as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ ssh -i .vagrant/machines/default/virtualbox/private_key vagrant@10.100.0.2 <span class="s2">&quot;cat /etc/nginx/.htpasswd&quot;</span>
</pre></div>
</div>
<p>The file should have an output similar to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>admin:$1$SIBL4POk$MlscIbwWALKAWY.TgbC3a.
</pre></div>
</div>
</li>
<li><p class="first">Running an Ansible ad-hoc command to check the content of the file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ ansible -i inventory/hosts.ini -a <span class="s2">&quot;cat /etc/nginx/.htpasswd&quot;</span> all --ask-vault-pass
</pre></div>
</div>
<p>The output should be similar to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Vault password:
127.0.0.1 | CHANGED | rc=0 &gt;&gt;
admin:$1$SIBL4POk$MlscIbwWALKAWY.TgbC3a.
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Notice how easy is to send ad-hoc remote commands using Ansible (taking advantage of the SSH configuration, we just need to focus on the remote action)</p>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="run-using-a-file-with-the-vault-password-in-it">
<h3>Run using a file with the vault password in it<a class="headerlink" href="#run-using-a-file-with-the-vault-password-in-it" title="Permalink to this headline">¶</a></h3>
<p>Create a file and store the password in it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ <span class="nb">echo</span> <span class="s2">&quot;vaultpassword&quot;</span> &gt; vaultPasswordFile
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I’m assuming the password is ‘vaultpassword’</p>
</div>
<p>Run the playbook specifying the file:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ ansible-playbook -i inventory/hosts.ini webservers.yml --vault-password-file ./vaultPasswordFile
</pre></div>
</div>
<p>The playbook should run successfully.</p>
</div>
<div class="section" id="run-using-the-vault-password-file-environment-variable">
<h3>Run using the vault password file environment variable<a class="headerlink" href="#run-using-the-vault-password-file-environment-variable" title="Permalink to this headline">¶</a></h3>
<p>Export the location of the password file as an environment variable:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ <span class="nb">export</span> <span class="nv">ANSIBLE_VAULT_PASSWORD_FILE</span><span class="o">=</span><span class="k">$(</span> <span class="nb">pwd</span> <span class="k">)</span>/vaultPasswordFile
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The value of ANSIBLE_VAULT_PASSWORD_FILE should be the absolute path to the file (hence we’re using ‘pwd’ to obtain it)</p>
</div>
<p>Run the playbook without specifying the vault password file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(.venv) ansible_2 $ ansible-playbook -i inventory/hosts.ini webservers.yml
</pre></div>
</div>
<p>The playbook should run successfully.</p>
<div class="section" id="bonus-specify-the-ansible-vault-password-file-var-without-exporting-it">
<h4>Bonus: specify the ANSIBLE_VAULT_PASSWORD_FILE var without exporting it<a class="headerlink" href="#bonus-specify-the-ansible-vault-password-file-var-without-exporting-it" title="Permalink to this headline">¶</a></h4>
<p>Just run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>.venv<span class="o">)</span> ansible_2 $ <span class="nv">ANSIBLE_VAULT_PASSWORD_FILE</span><span class="o">=</span><span class="k">$(</span> <span class="nb">pwd</span> <span class="k">)</span>/vaultPasswordFile ansible-playbook -i inventory/hosts.ini webservers.yml
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In modern shells (such as bash), you can pass any environment variable to a desired command</p>
</div>
<br/><p>Until here you have the knowledge to spin up Ansible, and configure it according to your requirements. It is true that the role we just created was very simple, however there is extended documentation regarding roles, specially using <a class="reference external" href="https://galaxy.ansible.com/">Ansible Galaxy</a>, which won’t be cover in this tutorial.</p>
<p>Let’s get to know more about Ansible in the next modules!</p>
<br/></div>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">Ansible Vault</a></li>
<li><a class="reference external" href="http://jinja.pocoo.org/docs/2.10/">Jinja</a></li>
<li><a class="reference external" href="https://www.nginx.com/">Nginx</a></li>
<li><a class="reference external" href="https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/#configuring-nginx-and-nginx-plus-for-http-basic-authentication">Basic HTTP authentication on Nginx</a></li>
<li><a class="reference external" href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html?highlight=ansible_vault_password_file#envvar-ANSIBLE_VAULT_PASSWORD_FILE">Ansible environment variables</a></li>
</ul>
</div>
</div>


          </div>
          <div id="search-results"><gcse:searchresults-only></div>
          <footer>
  
    <div class="rst-footer-buttons">
      
        <a href="3_modules_and_roles.html" class="btn btn-neutral float-right" title="3 - Working with modules and roles"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="1_playbook.html" class="btn btn-neutral" title="1 - Best practices and first playbook"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){
    w['SwiftypeObject']=n;w[n]=w[n] || function(){
      (w[n].q=w[n].q || []).push(arguments);
    };
    s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];
    s.async=1;
    s.src=u;
    e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','yABGvz2N8PwcwBxyfzUc','2.0.0');

  var check_search_link_exists = setInterval(function() {
    search_link = document.getElementsByClassName('st-search-show-outputs st-ui-search-tab');
    search_input_text = document.getElementById('st-overlay-search-input');
    if (search_link && search_input_text) {
      try{
        var search_message = "Search in Ansible docs";
        search_link[0].text = search_message;
        search_input_text.placeholder = search_message;
        clearInterval(check_search_link_exists);
      } catch {
        ;
      }
    }
  }, 100); // check every 100s

</script>

  <p>
  Last updated on Jun 13, 2020. <br/>
  </p>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.0.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../static/jquery.js"></script>
      <script type="text/javascript" src="../../static/underscore.js"></script>
      <script type="text/javascript" src="../../static/doctools.js"></script>
      <script type="text/javascript" src="../../static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../../static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 
<script type="text/javascript">
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
_satellite.pageBottom();
}
</script>
</body>
</html>